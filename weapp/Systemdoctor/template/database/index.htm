{include file="header.htm" /}
<style type="text/css">
    #error_notic_show p{
        margin: 5px 0px;
        font-size: 15px;
    }
</style>
<body style="background-color: #FFF; overflow: auto;">
<div id="toolTipLayer" style="position: absolute; z-index: 9999; display: none; visibility: visible; left: 95px; top: 573px;"></div>
<div id="append_parent"></div>
<div id="ajaxwaitid"></div>
<div class="page">
    <div class="fixed-bar">
        <div class="item-title">
            <a class="back_xin" href="{:weapp_url('Systemdoctor/Systemdoctor/index')}" title="返回列表"><i class="iconfont e-fanhui"></i></a>
            <div class="subject">
                <h3>校验数据库结构</h3>
                <h5></h5>
            </div>
        </div>
    </div>
    <!-- 操作说明 -->
    <div id="explanation" class="explanation" style="color: rgb(44, 188, 163); background-color: rgb(237, 251, 248); width: 99%; height: 100%;">
        <div id="checkZoom" class="title"><i class="fa fa-lightbulb-o"></i>
            <h4 title="提示相关设置操作时应注意的要点">提示</h4>
            <span title="收起提示" id="explanationZoom" style="display: block;"></span>
        </div>
        <ul>
            <li>1、只对系统内置的数据表、字段进行对比修正；</li>
            <li>2、会继续保留额外新增的数据表、插件安装的表、自定义字段、手工添加字段；</li>
        </ul>
    </div>
    <form class="form-horizontal" id="form1" method="post">
        <div class="ncap-form-default">
            <dl class="row" style="padding: 0px;">
                <dt class="tit" style="width: 0px;"></dt>
                <dd class="opt" id="error_notic_show"></dd>
            </dl>
            <div id="confirm_repair" class="bot" style="padding-left: 35px; padding-top: 10px; display: none;">
                <a class="ncap-btn-big ncap-btn-green" type="button" id="submitBtn" onclick="repair_table();">确认修正</a>
            </div>
            <div id="reset_check" class="bot" style="padding-left: 35px; padding-top: 10px;">
                <a class="ncap-btn-big ncap-btn-green" type="button" id="submitBtn" onclick="check_table();">开始检测</a>
            </div>
        </div>
    </div>
    </form>
</div>

<script type="text/javascript">
    var parentObj = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引

    function check_table() {
        layer_loading('正在处理');
        $.ajax({
            url: "{:weapp_url('Systemdoctor/Database/check_table')}",
            data: {_ajax:1},
            type: 'post',
            dataType: 'json',
            success: function (res) {
                layer.closeAll();
                if (1 == res.code) {
                    $('#reset_check').show();
                    $('#confirm_repair').hide();
                    $("#error_notic_show").html('检测完成，数据表结构一切正常。');
                    layer.msg(res.msg, {shade: 0.3, time: 1000});
                } else {
                    $('#reset_check').hide();
                    $('#confirm_repair').show();
                    $("#error_notic_show").html(res.msg);
                }
            },
            error: function(e) {
                layer.closeAll();
                layer.alert(e.responseText, {icon: 2, title:false});
            }
        });
    }

    function repair_table() {
        layer.confirm('修正前建议备份数据库，确定要直接修正？', {
                shade: layer_shade,
                area: ['480px', '190px'],
                move: false,
                title: '提示',
                btnAlign:'r',
                btn: ['确定', '取消'] ,//按钮
                success: function () {
                    $(".layui-layer-content").css('text-align', 'left');
                }
            }, function(){
                // 确定
                layer_loading('正在处理');
                $.ajax({
                    url: "{:weapp_url('Systemdoctor/Database/repair_table')}",
                    data: {_ajax:1},
                    type: 'post',
                    dataType: 'json',
                    success: function (res) {
                        layer.closeAll();
                        if (1 == res.code) {
                            $('#error_notic_show').html(res.msg);
                            $('#confirm_repair').hide();
                            $('#reset_check').show();
                            showErrorAlert(res.msg, 1);
                        } else {
                            if (res.data.error_sql && res.data.error_sql.length > 0) {
                                $.each(res.data.error_sql, function(index,item){
                                    console.log(item)
                                });
                            }
                            showErrorAlert(res.msg);
                        }
                    },
                    error: function(e) {
                        layer.closeAll();
                        layer.alert(e.responseText, {icon: 2, title:false});
                    }
                });
            }, function(index){
                layer.close(index);
            }
        );
    }
</script>
{include file="footer.htm" /}